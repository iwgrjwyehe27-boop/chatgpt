<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FrankieGPT</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        :root{
            --bg:#0b1020;
            --panel:#0f1724;
            --muted:#94a3b8;
            --accent:#7c5cff;
            --accent-2:#10a37f;
            --card:#0b1220;
            --text:#e6eef8;
        }
        [data-theme="ocean"]{
            --bg:#0a1828;
            --panel:#13283a;
            --muted:#8ba3b8;
            --accent:#00a8cc;
            --accent-2:#0097a7;
            --card:#0e2233;
            --text:#e0f2f7;
        }
        [data-theme="forest"]{
            --bg:#0d1b0d;
            --panel:#162816;
            --muted:#92a892;
            --accent:#4caf50;
            --accent-2:#2e7d32;
            --card:#111f11;
            --text:#e8f5e9;
        }
        [data-theme="sunset"]{
            --bg:#1a0f0a;
            --panel:#2a1a14;
            --muted:#b89a8a;
            --accent:#ff6b35;
            --accent-2:#e63946;
            --card:#1f1410;
            --text:#fff3e0;
        }
        [data-theme="midnight"]{
            --bg:#000000;
            --panel:#1a1a1a;
            --muted:#808080;
            --accent:#bb86fc;
            --accent-2:#03dac6;
            --card:#0d0d0d;
            --text:#ffffff;
        }
        [data-theme="lavender"]{
            --bg:#1a0f20;
            --panel:#2a1a3a;
            --muted:#b8a8c8;
            --accent:#b794f6;
            --accent-2:#9f7aea;
            --card:#1f1428;
            --text:#f3e8ff;
        }
        [data-theme="cherry"]{
            --bg:#1a0a14;
            --panel:#2a1424;
            --muted:#b88aa4;
            --accent:#ec4899;
            --accent-2:#be185d;
            --card:#1f0f19;
            --text:#fce7f3;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        html,body,#app{height:100%}
        body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto;background:var(--bg);color:var(--text)}
        .app{display:flex;height:100vh;}

        /* Animations */
        @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* Sidebar */
        .sidebar{width:260px;background:#071021;border-right:1px solid rgba(255,255,255,0.03);padding:18px;display:flex;flex-direction:column;gap:12px;overflow-y:auto;animation:slideIn 0.3s ease}
        .brand{color:var(--text);font-weight:700;margin-bottom:6px;font-size:14px;display:flex;align-items:center;gap:8px}
        .brand-logo{width:28px;height:28px}
        .new-chat-btn{color:var(--text);padding:10px;border-radius:8px;cursor:pointer;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);font-size:13px;text-align:left;transition:all 0.2s ease}
        .new-chat-btn:hover{background:rgba(255,255,255,0.1);transform:translateY(-2px)}
        .sidebar-section{margin-top:16px;border-top:1px solid rgba(255,255,255,0.05);padding-top:12px}
        .sidebar-label{color:var(--muted);font-size:11px;text-transform:uppercase;margin-bottom:8px;padding:0 10px}
        .chat-item{color:var(--muted);padding:10px;border-radius:8px;cursor:pointer;font-size:13px;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s ease;animation:slideIn 0.3s ease}
        .chat-item:hover{background:rgba(255,255,255,0.02);color:var(--text);transform:translateX(4px)}
        .chat-item.active{background:rgba(124,92,255,0.2);color:var(--accent);border-left:2px solid var(--accent)}
        .chat-item-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
        .chat-item-actions{display:none;gap:4px;margin-left:8px}
        .chat-item:hover .chat-item-actions{display:flex;animation:fadeIn 0.2s ease}
        .chat-item-btn{background:rgba(255,255,255,0.1);border:none;color:var(--muted);cursor:pointer;padding:4px 6px;border-radius:4px;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease}
        .chat-item-btn:hover{background:rgba(255,255,255,0.2);color:var(--text);transform:scale(1.1)}
        .sidebar-footer{margin-top:auto;border-top:1px solid rgba(255,255,255,0.05);padding-top:12px}
        .user-profile{display:flex;align-items:center;gap:10px;color:var(--text);font-size:13px;padding:8px;transition:all 0.2s ease}
        .user-avatar{width:32px;height:32px;border-radius:50%;overflow:hidden}
        .user-avatar img{width:100%;height:100%;object-fit:cover}
        .user-name{flex:1}
        .logout-btn{background:rgba(255,255,255,0.1);border:none;color:var(--muted);cursor:pointer;padding:4px 8px;border-radius:4px;font-size:11px;transition:all 0.2s ease;text-decoration:none;display:inline-block}
        .logout-btn:hover{background:rgba(255,255,255,0.2);color:var(--text)}

        /* Main content */
        .main{flex:1;display:flex;flex-direction:column}
        .main-inner{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column}

        /* Hero section */
        .hero-section{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;animation:fadeIn 0.5s ease}
        .hero-title{font-size:32px;font-weight:600;color:var(--text);text-align:center}
        .hero-subtitle{color:var(--muted);font-size:16px}
        .hero-section.hidden{display:none}

        /* Chat area */
        .chat-messages{display:flex;flex-direction:column;gap:16px;width:100%;max-width:880px;margin:0 auto;animation:slideUp 0.3s ease}
        .chat-messages.hidden{display:none}
        .message{display:flex;gap:12px;margin-bottom:8px;animation:slideUp 0.3s ease}
        .message.user{justify-content:flex-end}
        .message.user .content{background:var(--accent-2);color:#fff;max-width:70%;border-radius:12px;padding:12px 16px;word-wrap:break-word;line-height:1.5}
        .message.assistant .content{background:#0b1320;color:var(--text);max-width:70%;border-radius:12px;padding:12px 16px;word-wrap:break-word;border:1px solid rgba(255,255,255,0.02);line-height:1.5}

        /* Input area */
        .input-section{padding:18px;border-top:1px solid rgba(255,255,255,0.02);background:transparent}
        .input-wrapper{max-width:880px;margin:0 auto;width:100%}
        .input-form{display:flex;gap:8px;align-items:flex-end}
        .textarea-wrapper{flex:1;display:flex;gap:0;align-items:flex-end;position:relative}
        .input-form textarea{flex:1;padding:12px 14px;padding-right:50px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text);resize:none;max-height:120px;min-height:48px;font-family:inherit;font-size:14px;transition:all 0.2s ease}
        .input-form textarea:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,0.03)}
        .input-form button{background:var(--accent);color:white;padding:0;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center;width:48px;height:48px;font-size:24px;transition:all 0.2s ease}
        .input-form button:hover:not(:disabled){background:rgba(124,92,255,0.8);transform:scale(1.05)}
        .input-form button:disabled{background:var(--muted);cursor:not-allowed;opacity:0.5}
        .input-form .img-btn{position:absolute;right:6px;bottom:6px;background:transparent;color:var(--muted);width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;font-size:20px;border-radius:6px;transition:all 0.2s ease}
        .input-form .img-btn:hover{background:rgba(255,255,255,0.1);color:var(--text);transform:scale(1.1)}
        #sendBtn{transform:rotate(90deg)}
        .image-preview{display:flex;gap:8px;padding:8px 14px;flex-wrap:wrap;margin-bottom:8px}
        .image-thumb{width:60px;height:60px;border-radius:8px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.1)}
        .image-thumb img{width:100%;height:100%;object-fit:cover}
        .image-thumb .remove{position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.6);color:white;border:none;border-radius:4px;padding:2px 4px;cursor:pointer;font-size:11px;display:none}
        .image-thumb:hover .remove{display:block}
        .message-images{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
        .message-image{max-width:300px;max-height:300px;border-radius:8px;object-fit:cover}

        /* Modal */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:var(--panel);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px;max-width:400px;width:90%}
        .modal-title{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--text)}
        .modal-input{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,0.1);border-radius:8px;background:rgba(255,255,255,0.05);color:var(--text);font-size:14px;margin-bottom:16px}
        .modal-input:focus{outline:none;border-color:var(--accent)}
        .modal-buttons{display:flex;gap:12px;justify-content:flex-end}
        .modal-btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:14px}
        .modal-btn.confirm{background:var(--accent);color:white}
        .modal-btn.cancel{background:rgba(255,255,255,0.05);color:var(--muted)}
        
        /* Settings Modal */
        .settings-modal{max-width:700px;width:95%}
        .settings-tabs{display:flex;gap:8px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:20px}
        .settings-tab{padding:10px 20px;background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:14px;transition:all 0.2s;border-bottom:2px solid transparent}
        .settings-tab:hover{color:var(--text);background:rgba(255,255,255,0.02)}
        .settings-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
        .settings-panel{display:none}
        .settings-panel.active{display:block}
        .settings-section{margin-bottom:24px}
        .settings-section-title{font-size:14px;font-weight:600;margin-bottom:12px;color:var(--text)}
        .settings-row{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:8px}
        .settings-label{color:var(--text);font-size:14px}
        .settings-desc{color:var(--muted);font-size:12px;margin-top:4px}
        .theme-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:12px}
        .theme-card{padding:16px;border-radius:8px;border:2px solid rgba(255,255,255,0.1);cursor:pointer;transition:all 0.2s;text-align:center}
        .theme-card:hover{border-color:rgba(255,255,255,0.3);transform:translateY(-2px)}
        .theme-card.active{border-color:var(--accent);background:rgba(124,92,255,0.1)}
        .theme-preview{width:100%;height:40px;border-radius:6px;margin-bottom:8px;display:flex;gap:2px}
        .theme-preview-color{flex:1;border-radius:4px}
        .theme-name{font-size:13px;font-weight:600;color:var(--text)}
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="brand">
                <img src="/static/favicon.svg" alt="Logo" class="brand-logo">
                FrankieGPT
            </div>
            <button class="new-chat-btn" id="newChatBtn">+ New chat</button>

            <div class="sidebar-section">
                <div class="sidebar-label">Chats</div>
                <div id="chatList"></div>
            </div>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        {% if user.profile_image_url %}
                        <img src="{{ user.profile_image_url }}" alt="Profile">
                        {% else %}
                        <div style="width:100%;height:100%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700">
                            {{ user.username[0].upper() if user.username else 'U' }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="user-name">{{ user.username or 'User' }}</div>
                    <button class="logout-btn" id="settingsBtn" style="background:rgba(255,255,255,0.05);margin-right:8px">‚öôÔ∏è</button>
                    <a href="/logout" class="logout-btn">Logout</a>
                </div>
            </div>
        </aside>

        <main class="main">
            <div class="main-inner">
                <div class="hero-section" id="heroSection">
                    <div class="hero-title">What's on the agenda today?</div>
                    <div class="hero-subtitle">Ask anything</div>
                </div>

                <div class="chat-messages hidden" id="chatMessages"></div>
            </div>

            <div class="input-section">
                <div class="input-wrapper">
                    <div class="image-preview" id="imagePreview"></div>
                    <form class="input-form" id="chatForm">
                        <div class="textarea-wrapper">
                            <textarea id="messageInput" placeholder="Send a message..." autocomplete="off"></textarea>
                            <button type="button" class="img-btn" id="imageBtn" title="Add image">üìé</button>
                        </div>
                        <button type="submit" id="sendBtn">üì§</button>
                    </form>
                    <input type="file" id="imageInput" style="display:none" accept="image/*" multiple>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="renameChatModal">
        <div class="modal-content">
            <div class="modal-title">Rename Chat</div>
            <input type="text" class="modal-input" id="renameChatInput" placeholder="Enter chat name">
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="renameChatCancelBtn">Cancel</button>
                <button class="modal-btn confirm" id="renameChatConfirmBtn">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteChatModal">
        <div class="modal-content">
            <div class="modal-title">Delete Chat</div>
            <div style="color:var(--muted);margin-bottom:20px">Are you sure you want to delete this chat?</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="deleteChatCancelBtn">Cancel</button>
                <button class="modal-btn confirm" id="deleteChatConfirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content settings-modal">
            <div class="modal-title">Settings</div>
            
            <div class="settings-tabs">
                <button class="settings-tab active" data-tab="general">General</button>
                <button class="settings-tab" data-tab="account">Account</button>
                <button class="settings-tab" data-tab="customization">Customization</button>
            </div>
            
            <div class="settings-panel active" id="generalPanel">
                <div class="settings-section">
                    <div class="settings-section-title">Application</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Language</div>
                            <div class="settings-desc">Choose your preferred language</div>
                        </div>
                        <select id="languageSelect" style="padding:6px 12px;border-radius:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text)">
                            <option value="en">English</option>
                            <option value="es">Espa√±ol (Spanish)</option>
                            <option value="fr">Fran√ßais (French)</option>
                            <option value="de">Deutsch (German)</option>
                            <option value="it">Italiano (Italian)</option>
                            <option value="pt">Portugu√™s (Portuguese)</option>
                            <option value="ru">–†—É—Å—Å–∫–∏–π (Russian)</option>
                            <option value="zh">‰∏≠Êñá (Chinese)</option>
                            <option value="ja">Êó•Êú¨Ë™û (Japanese)</option>
                            <option value="ko">ÌïúÍµ≠Ïñ¥ (Korean)</option>
                            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</option>
                            <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                            <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                            <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)</option>
                            <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                            <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                            <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                            <option value="ur">ÿßÿ±ÿØŸà (Urdu)</option>
                            <option value="tr">T√ºrk√ße (Turkish)</option>
                            <option value="vi">Ti·∫øng Vi·ªát (Vietnamese)</option>
                            <option value="pl">Polski (Polish)</option>
                            <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (Ukrainian)</option>
                            <option value="nl">Nederlands (Dutch)</option>
                            <option value="sv">Svenska (Swedish)</option>
                            <option value="no">Norsk (Norwegian)</option>
                            <option value="da">Dansk (Danish)</option>
                            <option value="fi">Suomi (Finnish)</option>
                            <option value="cs">ƒåe≈°tina (Czech)</option>
                            <option value="el">ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨ (Greek)</option>
                            <option value="he">◊¢◊ë◊®◊ô◊™ (Hebrew)</option>
                            <option value="th">‡πÑ‡∏ó‡∏¢ (Thai)</option>
                            <option value="id">Bahasa Indonesia</option>
                            <option value="ms">Bahasa Melayu (Malay)</option>
                            <option value="fil">Filipino</option>
                            <option value="ro">Rom√¢nƒÉ (Romanian)</option>
                            <option value="hu">Magyar (Hungarian)</option>
                            <option value="sk">Slovenƒçina (Slovak)</option>
                            <option value="bg">–ë—ä–ª–≥–∞—Ä—Å–∫–∏ (Bulgarian)</option>
                            <option value="hr">Hrvatski (Croatian)</option>
                            <option value="sr">–°—Ä–ø—Å–∫–∏ (Serbian)</option>
                            <option value="lt">Lietuvi≈≥ (Lithuanian)</option>
                            <option value="lv">Latvie≈°u (Latvian)</option>
                            <option value="et">Eesti (Estonian)</option>
                            <option value="sl">Sloven≈°ƒçina (Slovenian)</option>
                            <option value="fa">ŸÅÿßÿ±ÿ≥€å (Persian)</option>
                            <option value="sw">Kiswahili (Swahili)</option>
                            <option value="am">·ä†·àõ·à≠·äõ (Amharic)</option>
                            <option value="ne">‡§®‡•á‡§™‡§æ‡§≤‡•Ä (Nepali)</option>
                            <option value="si">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω (Sinhala)</option>
                            <option value="km">·ûÅ·üí·ûò·üÇ·ûö (Khmer)</option>
                            <option value="my">·Äô·Äº·Äî·Ä∫·Äô·Ä¨ (Burmese)</option>
                            <option value="ka">·É•·Éê·É†·Éó·É£·Éö·Éò (Georgian)</option>
                            <option value="hy">’Ä’°’µ’•÷Ä’•’∂ (Armenian)</option>
                            <option value="az">Az…ôrbaycan (Azerbaijani)</option>
                            <option value="kk">“ö–∞–∑–∞“õ (Kazakh)</option>
                            <option value="uz">O'zbek (Uzbek)</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Auto-save Chats</div>
                            <div class="settings-desc">Automatically save chat history</div>
                        </div>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                            <input type="checkbox" id="autoSave" checked style="cursor:pointer">
                        </label>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Show Timestamps</div>
                            <div class="settings-desc">Display message timestamps</div>
                        </div>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                            <input type="checkbox" id="showTimestamps" style="cursor:pointer">
                        </label>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Sound Notifications</div>
                            <div class="settings-desc">Play sound on new messages</div>
                        </div>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                            <input type="checkbox" id="soundNotif" style="cursor:pointer">
                        </label>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Compact Mode</div>
                            <div class="settings-desc">Use compact message layout</div>
                        </div>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                            <input type="checkbox" id="compactMode" style="cursor:pointer">
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="settings-panel" id="accountPanel">
                <div class="settings-section">
                    <div class="settings-section-title">Profile</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Username</div>
                            <div class="settings-desc">Change your display name</div>
                        </div>
                        <button class="modal-btn confirm" id="renameAccountBtn" style="padding:6px 16px">Rename</button>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Email</div>
                            <div class="settings-desc">Update your email address</div>
                        </div>
                        <button class="modal-btn confirm" style="padding:6px 16px">Update</button>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Password</div>
                            <div class="settings-desc">Change your password</div>
                        </div>
                        <button class="modal-btn confirm" style="padding:6px 16px">Change</button>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Two-Factor Authentication</div>
                            <div class="settings-desc">Add extra security to your account</div>
                        </div>
                        <button class="modal-btn confirm" style="padding:6px 16px">Enable</button>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Export Data</div>
                            <div class="settings-desc">Download all your chat history</div>
                        </div>
                        <button class="modal-btn confirm" style="padding:6px 16px">Export</button>
                    </div>
                </div>
            </div>
            
            <div class="settings-panel" id="customizationPanel">
                <div class="settings-section">
                    <div class="settings-section-title">Theme</div>
                    <div class="theme-grid">
                        <div class="theme-card active" data-theme="default">
                            <div class="theme-preview">
                                <div class="theme-preview-color" style="background:#7c5cff"></div>
                                <div class="theme-preview-color" style="background:#10a37f"></div>
                                <div class="theme-preview-color" style="background:#0b1020"></div>
                            </div>
                            <div class="theme-name">Default</div>
                        </div>
                        <div class="theme-card" data-theme="ocean">
                            <div class="theme-preview">
                                <div class="theme-preview-color" style="background:#00a8cc"></div>
                                <div class="theme-preview-color" style="background:#0097a7"></div>
                                <div class="theme-preview-color" style="background:#0a1828"></div>
                            </div>
                            <div class="theme-name">Ocean</div>
                        </div>
                        <div class="theme-card" data-theme="forest">
                            <div class="theme-preview">
                                <div class="theme-preview-color" style="background:#4caf50"></div>
                                <div class="theme-preview-color" style="background:#2e7d32"></div>
                                <div class="theme-preview-color" style="background:#0d1b0d"></div>
                            </div>
                            <div class="theme-name">Forest</div>
                        </div>
                        <div class="theme-card" data-theme="sunset">
                            <div class="theme-preview">
                                <div class="theme-preview-color" style="background:#ff6b35"></div>
                                <div class="theme-preview-color" style="background:#e63946"></div>
                                <div class="theme-preview-color" style="background:#1a0f0a"></div>
                            </div>
                            <div class="theme-name">Sunset</div>
                        </div>
                        <div class="theme-card" data-theme="midnight">
                            <div class="theme-preview">
                                <div class="theme-preview-color" style="background:#bb86fc"></div>
                                <div class="theme-preview-color" style="background:#03dac6"></div>
                                <div class="theme-preview-color" style="background:#000000"></div>
                            </div>
                            <div class="theme-name">Midnight</div>
                        </div>
                        <div class="theme-card" data-theme="lavender">
                            <div class="theme-preview">
                                <div class="theme-preview-color" style="background:#b794f6"></div>
                                <div class="theme-preview-color" style="background:#9f7aea"></div>
                                <div class="theme-preview-color" style="background:#1a0f20"></div>
                            </div>
                            <div class="theme-name">Lavender</div>
                        </div>
                        <div class="theme-card" data-theme="cherry">
                            <div class="theme-preview">
                                <div class="theme-preview-color" style="background:#ec4899"></div>
                                <div class="theme-preview-color" style="background:#be185d"></div>
                                <div class="theme-preview-color" style="background:#1a0a14"></div>
                            </div>
                            <div class="theme-name">Cherry</div>
                        </div>
                    </div>
                </div>
                <div class="settings-section" style="margin-top:24px">
                    <div class="settings-section-title">Display</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Font Size</div>
                            <div class="settings-desc">Adjust message text size</div>
                        </div>
                        <select id="fontSize" style="padding:6px 12px;border-radius:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text)">
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium</option>
                            <option value="large">Large</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Message Density</div>
                            <div class="settings-desc">Spacing between messages</div>
                        </div>
                        <select id="messageDensity" style="padding:6px 12px;border-radius:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text)">
                            <option value="compact">Compact</option>
                            <option value="normal" selected>Normal</option>
                            <option value="comfortable">Comfortable</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Sidebar Width</div>
                            <div class="settings-desc">Adjust sidebar size</div>
                        </div>
                        <select id="sidebarWidth" style="padding:6px 12px;border-radius:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text)">
                            <option value="narrow">Narrow</option>
                            <option value="normal" selected>Normal</option>
                            <option value="wide">Wide</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Code Highlighting</div>
                            <div class="settings-desc">Syntax highlighting theme for code</div>
                        </div>
                        <select id="codeTheme" style="padding:6px 12px;border-radius:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text)">
                            <option value="monokai">Monokai</option>
                            <option value="github">GitHub</option>
                            <option value="dracula" selected>Dracula</option>
                            <option value="nord">Nord</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons" style="margin-top:20px">
                <button class="modal-btn cancel" id="settingsCloseBtn">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="renameAccountModal">
        <div class="modal-content">
            <div class="modal-title">Rename Account</div>
            <input type="text" class="modal-input" id="renameAccountInput" placeholder="Enter new username">
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="renameAccountCancelBtn">Cancel</button>
                <button class="modal-btn confirm" id="renameAccountConfirmBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        let currentChatId = null;
        let attachedImages = [];

        async function loadChats() {
            try {
                const res = await fetch('/api/chats');
                const data = await res.json();
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = '';

                data.chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'chat-item' + (currentChatId === chat.id ? ' active' : '');

                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'chat-item-title';
                    titleDiv.textContent = chat.title;
                    titleDiv.onclick = () => loadChat(chat.id);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'chat-item-actions';

                    const renameBtn = document.createElement('button');
                    renameBtn.className = 'chat-item-btn';
                    renameBtn.textContent = '‚úé';
                    renameBtn.onclick = (e) => {
                        e.stopPropagation();
                        document.getElementById('renameChatInput').value = chat.title;
                        document.getElementById('renameChatModal').classList.add('active');
                        document.getElementById('renameChatModal').dataset.chatId = chat.id;
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'chat-item-btn';
                    deleteBtn.textContent = 'üóëÔ∏è';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        document.getElementById('deleteChatModal').classList.add('active');
                        document.getElementById('deleteChatModal').dataset.chatId = chat.id;
                    };

                    actionsDiv.appendChild(renameBtn);
                    actionsDiv.appendChild(deleteBtn);
                    item.appendChild(titleDiv);
                    item.appendChild(actionsDiv);
                    chatList.appendChild(item);
                });
            } catch (err) {
                console.error('Failed to load chats:', err);
            }
        }

        async function loadChat(chatId) {
            try {
                const res = await fetch(`/api/chats/${chatId}`);
                const data = await res.json();
                currentChatId = chatId;

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';

                data.chat.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'message ' + msg.role;
                    const content = document.createElement('div');
                    content.className = 'content';
                    content.textContent = msg.text;

                    if (msg.images && msg.images.length > 0) {
                        const imagesContainer = document.createElement('div');
                        imagesContainer.className = 'message-images';
                        msg.images.forEach(imgBase64 => {
                            const img = document.createElement('img');
                            img.src = 'data:image/jpeg;base64,' + imgBase64;
                            img.className = 'message-image';
                            imagesContainer.appendChild(img);
                        });
                        content.appendChild(imagesContainer);
                    }

                    div.appendChild(content);
                    chatMessages.appendChild(div);
                });

                document.getElementById('heroSection').classList.add('hidden');
                document.getElementById('chatMessages').classList.remove('hidden');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                loadChats();
            } catch (err) {
                console.error('Failed to load chat:', err);
            }
        }

        async function createNewChat() {
            currentChatId = 'chat_' + Date.now();
            document.getElementById('heroSection').classList.remove('hidden');
            document.getElementById('chatMessages').classList.add('hidden');
            document.getElementById('messageInput').focus();
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            attachedImages.forEach((imgBase64, idx) => {
                const thumb = document.createElement('div');
                thumb.className = 'image-thumb';
                const img = document.createElement('img');
                img.src = 'data:image/jpeg;base64,' + imgBase64;
                thumb.appendChild(img);
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove';
                removeBtn.textContent = '‚úï';
                removeBtn.type = 'button';
                removeBtn.onclick = () => {
                    attachedImages.splice(idx, 1);
                    updateImagePreview();
                };
                thumb.appendChild(removeBtn);
                preview.appendChild(thumb);
            });
        }

        document.getElementById('newChatBtn').addEventListener('click', createNewChat);

        document.getElementById('imageBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            let processed = 0;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    attachedImages.push(event.target.result.split(',')[1]);
                    processed++;
                    if (processed === files.length) {
                        updateImagePreview();
                        document.getElementById('imageInput').value = '';
                    }
                };
                reader.readAsDataURL(file);
            });
        });

        document.getElementById('renameChatCancelBtn').addEventListener('click', () => {
            document.getElementById('renameChatModal').classList.remove('active');
        });

        document.getElementById('renameChatConfirmBtn').addEventListener('click', async () => {
            const chatId = document.getElementById('renameChatModal').dataset.chatId;
            const newTitle = document.getElementById('renameChatInput').value.trim();
            if (newTitle) {
                await fetch(`/api/chats/${chatId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: newTitle})
                });
                loadChats();
                document.getElementById('renameChatModal').classList.remove('active');
            }
        });

        document.getElementById('deleteChatCancelBtn').addEventListener('click', () => {
            document.getElementById('deleteChatModal').classList.remove('active');
        });

        document.getElementById('deleteChatConfirmBtn').addEventListener('click', async () => {
            const chatId = document.getElementById('deleteChatModal').dataset.chatId;
            await fetch(`/api/chats/${chatId}`, {method: 'DELETE'});
            if (currentChatId === chatId) {
                currentChatId = null;
                document.getElementById('heroSection').classList.remove('hidden');
                document.getElementById('chatMessages').classList.add('hidden');
            }
            loadChats();
            document.getElementById('deleteChatModal').classList.remove('active');
        });

        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('messageInput').value.trim();
            if (!text && attachedImages.length === 0) return;

            if (!currentChatId) {
                currentChatId = 'chat_' + Date.now();
                await fetch('/api/chats', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: currentChatId, title: text.substring(0, 30)})
                });
            }

            document.getElementById('heroSection').classList.add('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');
            document.getElementById('messageInput').value = '';
            document.getElementById('sendBtn').disabled = true;

            const chatMessages = document.getElementById('chatMessages');
            const userDiv = document.createElement('div');
            userDiv.className = 'message user';
            const userContent = document.createElement('div');
            userContent.className = 'content';
            userContent.textContent = text || '[Image message]';
            userDiv.appendChild(userContent);
            chatMessages.appendChild(userDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const res = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        question: text,
                        chat_id: currentChatId,
                        images: attachedImages.length > 0 ? attachedImages : undefined
                    })
                });
                const data = await res.json();

                const assistantDiv = document.createElement('div');
                assistantDiv.className = 'message assistant';
                const assistantContent = document.createElement('div');
                assistantContent.className = 'content';
                assistantContent.textContent = data.response || ('Error: ' + (data.error || 'Unknown error'));
                assistantDiv.appendChild(assistantContent);
                chatMessages.appendChild(assistantDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                loadChats();
            } catch (err) {
                console.error('Error:', err);
            }

            attachedImages = [];
            updateImagePreview();
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').focus();
        });

        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chatForm').dispatchEvent(new Event('submit'));
            }
        });

        // Settings modal
        document.getElementById('settingsBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('settingsModal').classList.add('active');
            loadSettings();
        });

        document.getElementById('settingsCloseBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.remove('active');
        });

        // Settings tabs
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');
            });
        });

        // Load and save settings
        function loadSettings() {
            const language = localStorage.getItem('language') || 'en';
            const autoSave = localStorage.getItem('autoSave') !== 'false';
            const showTimestamps = localStorage.getItem('showTimestamps') === 'true';
            const soundNotif = localStorage.getItem('soundNotif') === 'true';
            const compactMode = localStorage.getItem('compactMode') === 'true';
            const fontSize = localStorage.getItem('fontSize') || 'medium';
            const messageDensity = localStorage.getItem('messageDensity') || 'normal';
            const sidebarWidth = localStorage.getItem('sidebarWidth') || 'normal';
            const codeTheme = localStorage.getItem('codeTheme') || 'dracula';

            document.getElementById('languageSelect').value = language;
            document.getElementById('autoSave').checked = autoSave;
            document.getElementById('showTimestamps').checked = showTimestamps;
            document.getElementById('soundNotif').checked = soundNotif;
            document.getElementById('compactMode').checked = compactMode;
            document.getElementById('fontSize').value = fontSize;
            document.getElementById('messageDensity').value = messageDensity;
            document.getElementById('sidebarWidth').value = sidebarWidth;
            document.getElementById('codeTheme').value = codeTheme;
        }

        // Save settings on change
        document.getElementById('languageSelect').addEventListener('change', (e) => {
            localStorage.setItem('language', e.target.value);
        });

        document.getElementById('autoSave').addEventListener('change', (e) => {
            localStorage.setItem('autoSave', e.target.checked);
        });

        document.getElementById('showTimestamps').addEventListener('change', (e) => {
            localStorage.setItem('showTimestamps', e.target.checked);
        });

        document.getElementById('soundNotif').addEventListener('change', (e) => {
            localStorage.setItem('soundNotif', e.target.checked);
        });

        document.getElementById('compactMode').addEventListener('change', (e) => {
            localStorage.setItem('compactMode', e.target.checked);
        });

        document.getElementById('fontSize').addEventListener('change', (e) => {
            localStorage.setItem('fontSize', e.target.value);
        });

        document.getElementById('messageDensity').addEventListener('change', (e) => {
            localStorage.setItem('messageDensity', e.target.value);
        });

        document.getElementById('sidebarWidth').addEventListener('change', (e) => {
            localStorage.setItem('sidebarWidth', e.target.value);
        });

        document.getElementById('codeTheme').addEventListener('change', (e) => {
            localStorage.setItem('codeTheme', e.target.value);
        });

        // Theme switching
        const savedTheme = localStorage.getItem('theme') || 'default';
        if (savedTheme !== 'default') {
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.toggle('active', card.dataset.theme === savedTheme);
            });
        }

        document.querySelectorAll('.theme-card').forEach(card => {
            card.addEventListener('click', () => {
                const theme = card.dataset.theme;
                document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                
                if (theme === 'default') {
                    document.documentElement.removeAttribute('data-theme');
                } else {
                    document.documentElement.setAttribute('data-theme', theme);
                }
                localStorage.setItem('theme', theme);
            });
        });

        // Rename account
        document.getElementById('renameAccountBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.remove('active');
            document.getElementById('renameAccountModal').classList.add('active');
            document.getElementById('renameAccountInput').value = '{{ user.username }}';
        });

        document.getElementById('renameAccountCancelBtn').addEventListener('click', () => {
            document.getElementById('renameAccountModal').classList.remove('active');
        });

        document.getElementById('renameAccountConfirmBtn').addEventListener('click', async () => {
            const newUsername = document.getElementById('renameAccountInput').value.trim();
            if (newUsername) {
                try {
                    const res = await fetch('/api/user/update', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: newUsername})
                    });
                    
                    if (res.ok) {
                        location.reload();
                    } else {
                        const data = await res.json();
                        alert(data.error || 'Failed to update username');
                    }
                } catch (err) {
                    alert('Network error');
                }
            }
        });

        loadChats();
    </script>
</body>
</html>