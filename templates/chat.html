
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FrankieGPT</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        :root{
            --bg:#0b1020;
            --panel:#0f1724;
            --muted:#94a3b8;
            --accent:#7c5cff;
            --accent-2:#10a37f;
            --card:#0b1220;
            --text:#e6eef8;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        html,body,#app{height:100%}
        body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto;background:var(--bg);color:var(--text)}
        .app{display:flex;height:100vh;}

        /* Animations */
        @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* Sidebar */
        .sidebar{width:260px;background:#071021;border-right:1px solid rgba(255,255,255,0.03);padding:18px;display:flex;flex-direction:column;gap:12px;overflow-y:auto;animation:slideIn 0.3s ease}
        .brand{color:var(--text);font-weight:700;margin-bottom:6px;font-size:14px;display:flex;align-items:center;gap:8px}
        .brand-logo{width:28px;height:28px}
        .new-chat-btn{color:var(--text);padding:10px;border-radius:8px;cursor:pointer;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);font-size:13px;text-align:left;transition:all 0.2s ease}
        .new-chat-btn:hover{background:rgba(255,255,255,0.1);transform:translateY(-2px)}
        .sidebar-section{margin-top:16px;border-top:1px solid rgba(255,255,255,0.05);padding-top:12px}
        .sidebar-label{color:var(--muted);font-size:11px;text-transform:uppercase;margin-bottom:8px;padding:0 10px}
        .chat-item{color:var(--muted);padding:10px;border-radius:8px;cursor:pointer;font-size:13px;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s ease;animation:slideIn 0.3s ease}
        .chat-item:hover{background:rgba(255,255,255,0.02);color:var(--text);transform:translateX(4px)}
        .chat-item.active{background:rgba(124,92,255,0.2);color:var(--accent);border-left:2px solid var(--accent)}
        .chat-item-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
        .chat-item-actions{display:none;gap:4px;margin-left:8px}
        .chat-item:hover .chat-item-actions{display:flex;animation:fadeIn 0.2s ease}
        .chat-item-btn{background:rgba(255,255,255,0.1);border:none;color:var(--muted);cursor:pointer;padding:4px 6px;border-radius:4px;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease}
        .chat-item-btn:hover{background:rgba(255,255,255,0.2);color:var(--text);transform:scale(1.1)}
        .sidebar-footer{margin-top:auto;border-top:1px solid rgba(255,255,255,0.05);padding-top:12px}
        .user-profile{display:flex;align-items:center;gap:10px;color:var(--text);font-size:13px;padding:8px;transition:all 0.2s ease}
        .user-avatar{width:32px;height:32px;border-radius:50%;overflow:hidden}
        .user-avatar img{width:100%;height:100%;object-fit:cover}
        .user-name{flex:1}
        .logout-btn{background:rgba(255,255,255,0.1);border:none;color:var(--muted);cursor:pointer;padding:4px 8px;border-radius:4px;font-size:11px;transition:all 0.2s ease;text-decoration:none;display:inline-block}
        .logout-btn:hover{background:rgba(255,255,255,0.2);color:var(--text)}

        /* Main content */
        .main{flex:1;display:flex;flex-direction:column}
        .main-inner{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column}

        /* Hero section */
        .hero-section{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;animation:fadeIn 0.5s ease}
        .hero-title{font-size:32px;font-weight:600;color:var(--text);text-align:center}
        .hero-subtitle{color:var(--muted);font-size:16px}
        .hero-section.hidden{display:none}

        /* Chat area */
        .chat-messages{display:flex;flex-direction:column;gap:16px;width:100%;max-width:880px;margin:0 auto;animation:slideUp 0.3s ease}
        .chat-messages.hidden{display:none}
        .message{display:flex;gap:12px;margin-bottom:8px;animation:slideUp 0.3s ease}
        .message.user{justify-content:flex-end}
        .message.user .content{background:var(--accent-2);color:#fff;max-width:70%;border-radius:12px;padding:12px 16px;word-wrap:break-word;line-height:1.5}
        .message.assistant .content{background:#0b1320;color:var(--text);max-width:70%;border-radius:12px;padding:12px 16px;word-wrap:break-word;border:1px solid rgba(255,255,255,0.02);line-height:1.5}

        /* Input area */
        .input-section{padding:18px;border-top:1px solid rgba(255,255,255,0.02);background:transparent}
        .input-wrapper{max-width:880px;margin:0 auto;width:100%}
        .input-form{display:flex;gap:8px;align-items:flex-end}
        .textarea-wrapper{flex:1;display:flex;gap:0;align-items:flex-end;position:relative}
        .input-form textarea{flex:1;padding:12px 14px;padding-right:50px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text);resize:none;max-height:120px;min-height:48px;font-family:inherit;font-size:14px;transition:all 0.2s ease}
        .input-form textarea:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,0.03)}
        .input-form button{background:var(--accent);color:white;padding:0;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center;width:48px;height:48px;font-size:24px;transition:all 0.2s ease}
        .input-form button:hover:not(:disabled){background:rgba(124,92,255,0.8);transform:scale(1.05)}
        .input-form button:disabled{background:var(--muted);cursor:not-allowed;opacity:0.5}
        .input-form .img-btn{position:absolute;right:6px;bottom:6px;background:transparent;color:var(--muted);width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;font-size:20px;border-radius:6px;transition:all 0.2s ease}
        .input-form .img-btn:hover{background:rgba(255,255,255,0.1);color:var(--text);transform:scale(1.1)}
        #sendBtn{transform:rotate(90deg)}
        .image-preview{display:flex;gap:8px;padding:8px 14px;flex-wrap:wrap;margin-bottom:8px}
        .image-thumb{width:60px;height:60px;border-radius:8px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.1)}
        .image-thumb img{width:100%;height:100%;object-fit:cover}
        .image-thumb .remove{position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.6);color:white;border:none;border-radius:4px;padding:2px 4px;cursor:pointer;font-size:11px;display:none}
        .image-thumb:hover .remove{display:block}
        .message-images{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
        .message-image{max-width:300px;max-height:300px;border-radius:8px;object-fit:cover}

        /* Modal */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:var(--panel);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px;max-width:400px;width:90%}
        .modal-title{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--text)}
        .modal-input{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,0.1);border-radius:8px;background:rgba(255,255,255,0.05);color:var(--text);font-size:14px;margin-bottom:16px}
        .modal-input:focus{outline:none;border-color:var(--accent)}
        .modal-buttons{display:flex;gap:12px;justify-content:flex-end}
        .modal-btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:14px}
        .modal-btn.confirm{background:var(--accent);color:white}
        .modal-btn.cancel{background:rgba(255,255,255,0.05);color:var(--muted)}
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="brand">
                <img src="/static/favicon.svg" alt="Logo" class="brand-logo">
                FrankieGPT
            </div>
            <button class="new-chat-btn" id="newChatBtn">+ New chat</button>

            <div class="sidebar-section">
                <div class="sidebar-label">Chats</div>
                <div id="chatList"></div>
            </div>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        {% if user.profile_image_url %}
                        <img src="{{ user.profile_image_url }}" alt="Profile">
                        {% else %}
                        <div style="width:100%;height:100%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700">
                            {{ user.first_name[0] if user.first_name else 'U' }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="user-name">{{ user.first_name or 'User' }}</div>
                    <a href="/auth/logout" class="logout-btn">Logout</a>
                </div>
            </div>
        </aside>

        <main class="main">
            <div class="main-inner">
                <div class="hero-section" id="heroSection">
                    <div class="hero-title">What's on the agenda today?</div>
                    <div class="hero-subtitle">Ask anything</div>
                </div>

                <div class="chat-messages hidden" id="chatMessages"></div>
            </div>

            <div class="input-section">
                <div class="input-wrapper">
                    <div class="image-preview" id="imagePreview"></div>
                    <form class="input-form" id="chatForm">
                        <div class="textarea-wrapper">
                            <textarea id="messageInput" placeholder="Send a message..." autocomplete="off"></textarea>
                            <button type="button" class="img-btn" id="imageBtn" title="Add image">ðŸ“Ž</button>
                        </div>
                        <button type="submit" id="sendBtn">ðŸ“¤</button>
                    </form>
                    <input type="file" id="imageInput" style="display:none" accept="image/*" multiple>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="renameChatModal">
        <div class="modal-content">
            <div class="modal-title">Rename Chat</div>
            <input type="text" class="modal-input" id="renameChatInput" placeholder="Enter chat name">
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="renameChatCancelBtn">Cancel</button>
                <button class="modal-btn confirm" id="renameChatConfirmBtn">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteChatModal">
        <div class="modal-content">
            <div class="modal-title">Delete Chat</div>
            <div style="color:var(--muted);margin-bottom:20px">Are you sure you want to delete this chat?</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="deleteChatCancelBtn">Cancel</button>
                <button class="modal-btn confirm" id="deleteChatConfirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let currentChatId = null;
        let attachedImages = [];

        async function loadChats() {
            try {
                const res = await fetch('/api/chats');
                const data = await res.json();
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = '';

                data.chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'chat-item' + (currentChatId === chat.id ? ' active' : '');

                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'chat-item-title';
                    titleDiv.textContent = chat.title;
                    titleDiv.onclick = () => loadChat(chat.id);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'chat-item-actions';

                    const renameBtn = document.createElement('button');
                    renameBtn.className = 'chat-item-btn';
                    renameBtn.textContent = 'âœŽ';
                    renameBtn.onclick = (e) => {
                        e.stopPropagation();
                        document.getElementById('renameChatInput').value = chat.title;
                        document.getElementById('renameChatModal').classList.add('active');
                        document.getElementById('renameChatModal').dataset.chatId = chat.id;
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'chat-item-btn';
                    deleteBtn.textContent = 'ðŸ—‘ï¸';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        document.getElementById('deleteChatModal').classList.add('active');
                        document.getElementById('deleteChatModal').dataset.chatId = chat.id;
                    };

                    actionsDiv.appendChild(renameBtn);
                    actionsDiv.appendChild(deleteBtn);
                    item.appendChild(titleDiv);
                    item.appendChild(actionsDiv);
                    chatList.appendChild(item);
                });
            } catch (err) {
                console.error('Failed to load chats:', err);
            }
        }

        async function loadChat(chatId) {
            try {
                const res = await fetch(`/api/chats/${chatId}`);
                const data = await res.json();
                currentChatId = chatId;

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';

                data.chat.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'message ' + msg.role;
                    const content = document.createElement('div');
                    content.className = 'content';
                    content.textContent = msg.text;

                    if (msg.images && msg.images.length > 0) {
                        const imagesContainer = document.createElement('div');
                        imagesContainer.className = 'message-images';
                        msg.images.forEach(imgBase64 => {
                            const img = document.createElement('img');
                            img.src = 'data:image/jpeg;base64,' + imgBase64;
                            img.className = 'message-image';
                            imagesContainer.appendChild(img);
                        });
                        content.appendChild(imagesContainer);
                    }

                    div.appendChild(content);
                    chatMessages.appendChild(div);
                });

                document.getElementById('heroSection').classList.add('hidden');
                document.getElementById('chatMessages').classList.remove('hidden');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                loadChats();
            } catch (err) {
                console.error('Failed to load chat:', err);
            }
        }

        async function createNewChat() {
            currentChatId = 'chat_' + Date.now();
            document.getElementById('heroSection').classList.remove('hidden');
            document.getElementById('chatMessages').classList.add('hidden');
            document.getElementById('messageInput').focus();
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            attachedImages.forEach((imgBase64, idx) => {
                const thumb = document.createElement('div');
                thumb.className = 'image-thumb';
                const img = document.createElement('img');
                img.src = 'data:image/jpeg;base64,' + imgBase64;
                thumb.appendChild(img);
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove';
                removeBtn.textContent = 'âœ•';
                removeBtn.type = 'button';
                removeBtn.onclick = () => {
                    attachedImages.splice(idx, 1);
                    updateImagePreview();
                };
                thumb.appendChild(removeBtn);
                preview.appendChild(thumb);
            });
        }

        document.getElementById('newChatBtn').addEventListener('click', createNewChat);

        document.getElementById('imageBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            let processed = 0;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    attachedImages.push(event.target.result.split(',')[1]);
                    processed++;
                    if (processed === files.length) {
                        updateImagePreview();
                        document.getElementById('imageInput').value = '';
                    }
                };
                reader.readAsDataURL(file);
            });
        });

        document.getElementById('renameChatCancelBtn').addEventListener('click', () => {
            document.getElementById('renameChatModal').classList.remove('active');
        });

        document.getElementById('renameChatConfirmBtn').addEventListener('click', async () => {
            const chatId = document.getElementById('renameChatModal').dataset.chatId;
            const newTitle = document.getElementById('renameChatInput').value.trim();
            if (newTitle) {
                await fetch(`/api/chats/${chatId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: newTitle})
                });
                loadChats();
                document.getElementById('renameChatModal').classList.remove('active');
            }
        });

        document.getElementById('deleteChatCancelBtn').addEventListener('click', () => {
            document.getElementById('deleteChatModal').classList.remove('active');
        });

        document.getElementById('deleteChatConfirmBtn').addEventListener('click', async () => {
            const chatId = document.getElementById('deleteChatModal').dataset.chatId;
            await fetch(`/api/chats/${chatId}`, {method: 'DELETE'});
            if (currentChatId === chatId) {
                currentChatId = null;
                document.getElementById('heroSection').classList.remove('hidden');
                document.getElementById('chatMessages').classList.add('hidden');
            }
            loadChats();
            document.getElementById('deleteChatModal').classList.remove('active');
        });

        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('messageInput').value.trim();
            if (!text && attachedImages.length === 0) return;

            if (!currentChatId) {
                currentChatId = 'chat_' + Date.now();
                await fetch('/api/chats', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: currentChatId, title: text.substring(0, 30)})
                });
            }

            document.getElementById('heroSection').classList.add('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');
            document.getElementById('messageInput').value = '';
            document.getElementById('sendBtn').disabled = true;

            const chatMessages = document.getElementById('chatMessages');
            const userDiv = document.createElement('div');
            userDiv.className = 'message user';
            const userContent = document.createElement('div');
            userContent.className = 'content';
            userContent.textContent = text || '[Image message]';
            userDiv.appendChild(userContent);
            chatMessages.appendChild(userDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const res = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        question: text,
                        chat_id: currentChatId,
                        images: attachedImages.length > 0 ? attachedImages : undefined
                    })
                });
                const data = await res.json();

                const assistantDiv = document.createElement('div');
                assistantDiv.className = 'message assistant';
                const assistantContent = document.createElement('div');
                assistantContent.className = 'content';
                assistantContent.textContent = data.response || ('Error: ' + (data.error || 'Unknown error'));
                assistantDiv.appendChild(assistantContent);
                chatMessages.appendChild(assistantDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                loadChats();
            } catch (err) {
                console.error('Error:', err);
            }

            attachedImages = [];
            updateImagePreview();
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').focus();
        });

        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chatForm').dispatchEvent(new Event('submit'));
            }
        });

        loadChats();
    </script>
</body>
</html>
